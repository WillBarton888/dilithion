name: Fuzzing Extended Campaigns

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      duration_hours:
        description: 'Campaign duration per fuzzer (hours)'
        required: true
        default: '6'
        type: choice
        options:
          - '2'
          - '4'
          - '6'
  schedule:
    # Run nightly at 2 AM UTC (optional)
    - cron: '0 2 * * *'

jobs:
  # Tier 1: Consensus-critical fuzzers (6 hours each)
  fuzz-difficulty:
    name: "Difficulty Adjustment (Tier 1)"
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-14 libfuzzer-14-dev cmake build-essential libleveldb-dev

      - name: Build RandomX dependency
        run: |
          cd depends/randomx
          mkdir -p build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make -j$(nproc)

      - name: Build Dilithium objects
        run: |
          cd depends/dilithium/ref
          gcc -O2 -DDILITHIUM_MODE=3 -I . -c sign.c packing.c polyvec.c poly.c ntt.c reduce.c rounding.c symmetric-shake.c fips202.c randombytes.c

      - name: Build fuzz_difficulty
        run: |
          make fuzz_difficulty

      - name: Run fuzzing campaign
        run: |
          mkdir -p fuzz_corpus/difficulty
          DURATION=${{ github.event.inputs.duration_hours || '6' }}
          DURATION_SECONDS=$((DURATION * 3600))

          timeout ${DURATION_SECONDS}s ./fuzz_difficulty \
            -max_total_time=${DURATION_SECONDS} \
            -workers=2 \
            -timeout=60 \
            -rss_limit_mb=2048 \
            -print_final_stats=1 \
            fuzz_corpus/difficulty/ \
            2>&1 | tee fuzz_difficulty_campaign.log || true

      - name: Check for crashes
        run: |
          if ls crash-* 2>/dev/null || ls leak-* 2>/dev/null || ls timeout-* 2>/dev/null; then
            echo "⚠️ CRASHES FOUND!"
            ls -lh crash-* leak-* timeout-* 2>/dev/null || true
            exit 1
          else
            echo "✅ No crashes found"
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-difficulty-results
          path: |
            fuzz_difficulty_campaign.log
            crash-*
            leak-*
            timeout-*
            fuzz_corpus/difficulty/
          retention-days: 30

  fuzz-tx-validation:
    name: "Transaction Validation (Tier 1)"
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-14 libfuzzer-14-dev cmake build-essential libleveldb-dev

      - name: Build RandomX dependency
        run: |
          cd depends/randomx
          mkdir -p build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make -j$(nproc)

      - name: Build Dilithium objects
        run: |
          cd depends/dilithium/ref
          gcc -O2 -DDILITHIUM_MODE=3 -I . -c sign.c packing.c polyvec.c poly.c ntt.c reduce.c rounding.c symmetric-shake.c fips202.c randombytes.c

      - name: Build fuzz_tx_validation
        run: |
          make fuzz_tx_validation

      - name: Run fuzzing campaign
        run: |
          mkdir -p fuzz_corpus/tx_validation
          DURATION=${{ github.event.inputs.duration_hours || '6' }}
          DURATION_SECONDS=$((DURATION * 3600))

          timeout ${DURATION_SECONDS}s ./fuzz_tx_validation \
            -max_total_time=${DURATION_SECONDS} \
            -workers=2 \
            -timeout=60 \
            -rss_limit_mb=2048 \
            -print_final_stats=1 \
            fuzz_corpus/tx_validation/ \
            2>&1 | tee fuzz_tx_validation_campaign.log || true

      - name: Check for crashes
        run: |
          if ls crash-* 2>/dev/null || ls leak-* 2>/dev/null || ls timeout-* 2>/dev/null; then
            echo "⚠️ CRASHES FOUND!"
            ls -lh crash-* leak-* timeout-* 2>/dev/null || true
            exit 1
          else
            echo "✅ No crashes found"
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-tx-validation-results
          path: |
            fuzz_tx_validation_campaign.log
            crash-*
            leak-*
            timeout-*
            fuzz_corpus/tx_validation/
          retention-days: 30

  fuzz-utxo:
    name: "UTXO Management (Tier 1)"
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-14 libfuzzer-14-dev cmake build-essential libleveldb-dev

      - name: Build RandomX dependency
        run: |
          cd depends/randomx
          mkdir -p build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make -j$(nproc)

      - name: Build Dilithium objects
        run: |
          cd depends/dilithium/ref
          gcc -O2 -DDILITHIUM_MODE=3 -I . -c sign.c packing.c polyvec.c poly.c ntt.c reduce.c rounding.c symmetric-shake.c fips202.c randombytes.c

      - name: Build fuzz_utxo
        run: |
          make fuzz_utxo

      - name: Run fuzzing campaign
        run: |
          mkdir -p fuzz_corpus/utxo
          DURATION=${{ github.event.inputs.duration_hours || '6' }}
          DURATION_SECONDS=$((DURATION * 3600))

          timeout ${DURATION_SECONDS}s ./fuzz_utxo \
            -max_total_time=${DURATION_SECONDS} \
            -workers=2 \
            -timeout=60 \
            -rss_limit_mb=2048 \
            -print_final_stats=1 \
            fuzz_corpus/utxo/ \
            2>&1 | tee fuzz_utxo_campaign.log || true

      - name: Check for crashes
        run: |
          if ls crash-* 2>/dev/null || ls leak-* 2>/dev/null || ls timeout-* 2>/dev/null; then
            echo "⚠️ CRASHES FOUND!"
            ls -lh crash-* leak-* timeout-* 2>/dev/null || true
            exit 1
          else
            echo "✅ No crashes found"
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-utxo-results
          path: |
            fuzz_utxo_campaign.log
            crash-*
            leak-*
            timeout-*
            fuzz_corpus/utxo/
          retention-days: 30

  # Tier 2: High-priority fuzzers (4 hours each)
  fuzz-block:
    name: "Block Headers (Tier 2)"
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4 hours

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-14 libfuzzer-14-dev cmake build-essential libleveldb-dev

      - name: Build dependencies
        run: |
          cd depends/randomx && mkdir -p build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release .. && make -j$(nproc)

      - name: Build Dilithium objects
        run: |
          cd depends/dilithium/ref
          gcc -O2 -DDILITHIUM_MODE=3 -I . -c sign.c packing.c polyvec.c poly.c ntt.c reduce.c rounding.c symmetric-shake.c fips202.c randombytes.c

      - name: Build and run fuzzer
        run: |
          make fuzz_block
          mkdir -p fuzz_corpus/block
          DURATION=${{ github.event.inputs.duration_hours || '4' }}
          DURATION_SECONDS=$((DURATION * 3600))

          timeout ${DURATION_SECONDS}s ./fuzz_block \
            -max_total_time=${DURATION_SECONDS} \
            -workers=2 \
            -print_final_stats=1 \
            fuzz_corpus/block/ \
            2>&1 | tee fuzz_block_campaign.log || true

      - name: Check for crashes
        run: |
          if ls crash-* leak-* timeout-* 2>/dev/null; then
            echo "⚠️ CRASHES FOUND!" && exit 1
          else
            echo "✅ No crashes"
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-block-results
          path: |
            fuzz_block_campaign.log
            crash-*
            leak-*
            timeout-*
          retention-days: 30

  fuzz-merkle:
    name: "Merkle Trees (Tier 2)"
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-14 libfuzzer-14-dev cmake build-essential libleveldb-dev

      - name: Build dependencies
        run: |
          cd depends/randomx && mkdir -p build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release .. && make -j$(nproc)

      - name: Build Dilithium objects
        run: |
          cd depends/dilithium/ref
          gcc -O2 -DDILITHIUM_MODE=3 -I . -c sign.c packing.c polyvec.c poly.c ntt.c reduce.c rounding.c symmetric-shake.c fips202.c randombytes.c

      - name: Build and run fuzzer
        run: |
          make fuzz_merkle
          mkdir -p fuzz_corpus/merkle
          DURATION=${{ github.event.inputs.duration_hours || '4' }}
          DURATION_SECONDS=$((DURATION * 3600))

          timeout ${DURATION_SECONDS}s ./fuzz_merkle \
            -max_total_time=${DURATION_SECONDS} \
            -workers=2 \
            -print_final_stats=1 \
            fuzz_corpus/merkle/ \
            2>&1 | tee fuzz_merkle_campaign.log || true

      - name: Check for crashes
        run: |
          if ls crash-* leak-* timeout-* 2>/dev/null; then
            echo "⚠️ CRASHES FOUND!" && exit 1
          else
            echo "✅ No crashes"
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-merkle-results
          path: |
            fuzz_merkle_campaign.log
            crash-*
            leak-*
            timeout-*
          retention-days: 30

  fuzz-transaction:
    name: "Transaction Parsing (Tier 2)"
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-14 libfuzzer-14-dev cmake build-essential libleveldb-dev

      - name: Build dependencies
        run: |
          cd depends/randomx && mkdir -p build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release .. && make -j$(nproc)

      - name: Build Dilithium objects
        run: |
          cd depends/dilithium/ref
          gcc -O2 -DDILITHIUM_MODE=3 -I . -c sign.c packing.c polyvec.c poly.c ntt.c reduce.c rounding.c symmetric-shake.c fips202.c randombytes.c

      - name: Build and run fuzzer
        run: |
          make fuzz_transaction
          mkdir -p fuzz_corpus/transaction
          DURATION=${{ github.event.inputs.duration_hours || '4' }}
          DURATION_SECONDS=$((DURATION * 3600))

          timeout ${DURATION_SECONDS}s ./fuzz_transaction \
            -max_total_time=${DURATION_SECONDS} \
            -workers=2 \
            -print_final_stats=1 \
            fuzz_corpus/transaction/ \
            2>&1 | tee fuzz_transaction_campaign.log || true

      - name: Check for crashes
        run: |
          if ls crash-* leak-* timeout-* 2>/dev/null; then
            echo "⚠️ CRASHES FOUND!" && exit 1
          else
            echo "✅ No crashes"
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-transaction-results
          path: |
            fuzz_transaction_campaign.log
            crash-*
            leak-*
            timeout-*
          retention-days: 30

  # Tier 3: Fast fuzzers (2 hours each)
  fuzz-subsidy:
    name: "Block Subsidy (Tier 3)"
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-14 libfuzzer-14-dev

      - name: Build Dilithium objects
        run: |
          cd depends/dilithium/ref
          gcc -O2 -DDILITHIUM_MODE=3 -I . -c sign.c packing.c polyvec.c poly.c ntt.c reduce.c rounding.c symmetric-shake.c fips202.c randombytes.c

      - name: Build and run fuzzer
        run: |
          make fuzz_subsidy
          mkdir -p fuzz_corpus/subsidy
          DURATION=${{ github.event.inputs.duration_hours || '2' }}
          DURATION_SECONDS=$((DURATION * 3600))

          timeout ${DURATION_SECONDS}s ./fuzz_subsidy \
            -max_total_time=${DURATION_SECONDS} \
            -workers=2 \
            -print_final_stats=1 \
            fuzz_corpus/subsidy/ \
            2>&1 | tee fuzz_subsidy_campaign.log || true

      - name: Check for crashes
        run: |
          if ls crash-* leak-* timeout-* 2>/dev/null; then
            echo "⚠️ CRASHES FOUND!" && exit 1
          else
            echo "✅ No crashes"
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-subsidy-results
          path: |
            fuzz_subsidy_campaign.log
            crash-*
            leak-*
            timeout-*
          retention-days: 30

  fuzz-compactsize:
    name: "CompactSize Encoding (Tier 3)"
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-14 libfuzzer-14-dev

      - name: Build Dilithium objects
        run: |
          cd depends/dilithium/ref
          gcc -O2 -DDILITHIUM_MODE=3 -I . -c sign.c packing.c polyvec.c poly.c ntt.c reduce.c rounding.c symmetric-shake.c fips202.c randombytes.c

      - name: Build and run fuzzer
        run: |
          make fuzz_compactsize
          mkdir -p fuzz_corpus/compactsize
          DURATION=${{ github.event.inputs.duration_hours || '2' }}
          DURATION_SECONDS=$((DURATION * 3600))

          timeout ${DURATION_SECONDS}s ./fuzz_compactsize \
            -max_total_time=${DURATION_SECONDS} \
            -workers=2 \
            -print_final_stats=1 \
            fuzz_corpus/compactsize/ \
            2>&1 | tee fuzz_compactsize_campaign.log || true

      - name: Check for crashes
        run: |
          if ls crash-* leak-* timeout-* 2>/dev/null; then
            echo "⚠️ CRASHES FOUND!" && exit 1
          else
            echo "✅ No crashes"
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-compactsize-results
          path: |
            fuzz_compactsize_campaign.log
            crash-*
            leak-*
            timeout-*
          retention-days: 30

  fuzz-sha3:
    name: "SHA3-256 (Tier 3)"
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-14 libfuzzer-14-dev

      - name: Build Dilithium objects
        run: |
          cd depends/dilithium/ref
          gcc -O2 -DDILITHIUM_MODE=3 -I . -c sign.c packing.c polyvec.c poly.c ntt.c reduce.c rounding.c symmetric-shake.c fips202.c randombytes.c

      - name: Build and run fuzzer
        run: |
          make fuzz_sha3
          mkdir -p fuzz_corpus/sha3
          DURATION=${{ github.event.inputs.duration_hours || '2' }}
          DURATION_SECONDS=$((DURATION * 3600))

          timeout ${DURATION_SECONDS}s ./fuzz_sha3 \
            -max_total_time=${DURATION_SECONDS} \
            -workers=2 \
            -print_final_stats=1 \
            fuzz_corpus/sha3/ \
            2>&1 | tee fuzz_sha3_campaign.log || true

      - name: Check for crashes
        run: |
          if ls crash-* leak-* timeout-* 2>/dev/null; then
            echo "⚠️ CRASHES FOUND!" && exit 1
          else
            echo "✅ No crashes"
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-sha3-results
          path: |
            fuzz_sha3_campaign.log
            crash-*
            leak-*
            timeout-*
          retention-days: 30

  # Summary job - collects results from all fuzzers
  summary:
    name: "Campaign Summary"
    runs-on: ubuntu-latest
    needs: [fuzz-difficulty, fuzz-tx-validation, fuzz-utxo, fuzz-block, fuzz-merkle, fuzz-transaction, fuzz-subsidy, fuzz-compactsize, fuzz-sha3]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: campaign-results

      - name: Generate summary report
        run: |
          echo "# Fuzzing Campaign Results" > summary.md
          echo "" >> summary.md
          echo "**Date:** $(date)" >> summary.md
          echo "**Duration:** ${{ github.event.inputs.duration_hours || 'default' }} hours per tier" >> summary.md
          echo "" >> summary.md

          echo "## Results by Fuzzer" >> summary.md
          echo "" >> summary.md

          for dir in campaign-results/*/; do
            fuzzer=$(basename "$dir" | sed 's/-results$//')
            echo "### $fuzzer" >> summary.md

            if ls "$dir"crash-* 2>/dev/null || ls "$dir"leak-* 2>/dev/null; then
              echo "⚠️ **CRASHES FOUND**" >> summary.md
              echo '```' >> summary.md
              ls -lh "$dir"crash-* "$dir"leak-* "$dir"timeout-* 2>/dev/null || true
              echo '```' >> summary.md
            else
              echo "✅ No crashes detected" >> summary.md
            fi

            if [ -f "$dir"*.log ]; then
              echo "" >> summary.md
              echo "**Stats:**" >> summary.md
              echo '```' >> summary.md
              grep -E "Done|exec/s|cov:|ft:" "$dir"*.log | tail -5 || echo "No stats found"
              echo '```' >> summary.md
            fi

            echo "" >> summary.md
          done

          cat summary.md

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: campaign-summary
          path: summary.md
          retention-days: 90
