name: Build macOS Release

on:
  workflow_dispatch:  # Manual trigger
  push:
    tags:
      - 'v*'  # Trigger on version tags

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        brew install leveldb cmake openssl

    - name: Build RandomX
      run: |
        cd depends/randomx
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(sysctl -n hw.ncpu)
        ls -lh librandomx.a

    - name: Build Dilithion
      run: |
        # Find OpenSSL installation path
        OPENSSL_PREFIX=$(brew --prefix openssl@3 2>/dev/null || brew --prefix openssl 2>/dev/null || echo "/opt/homebrew/opt/openssl@3")
        echo "Using OpenSSL at: $OPENSSL_PREFIX"
        export CPPFLAGS="-I$OPENSSL_PREFIX/include"
        export LDFLAGS="-L$OPENSSL_PREFIX/lib"
        export CFLAGS="-I$OPENSSL_PREFIX/include"
        export CXXFLAGS="-I$OPENSSL_PREFIX/include"
        make clean
        make -j$(sysctl -n hw.ncpu) CPPFLAGS="$CPPFLAGS" LDFLAGS="$LDFLAGS"
        ls -lh dilithion-node check-wallet-balance genesis_gen

    - name: Create release package
      run: |
        chmod +x package-macos-release.sh
        ./package-macos-release.sh

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dilithion-macos-package
        path: releases/dilithion-testnet-v1.0.8-macos-x64.tar.gz

    - name: Upload to release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: releases/dilithion-testnet-v1.0.8-macos-x64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
