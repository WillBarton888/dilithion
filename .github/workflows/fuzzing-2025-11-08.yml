name: Fuzzing Infrastructure Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-fuzzers:
    name: Build All Fuzzers (20 harnesses)
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang-14 \
            libc++-14-dev \
            libc++abi-14-dev \
            build-essential \
            cmake \
            libleveldb-dev \
            git

      - name: Build RandomX
        run: |
          cd depends/randomx
          mkdir -p build && cd build
          cmake ..
          make -j$(nproc)

      - name: Build Dilithium library
        run: |
          if [ ! -f depends/dilithium/ref/sign.c ]; then
            echo "ERROR: Dilithium source files missing. They should be tracked in the repo."
            exit 1
          fi
          if [ ! -f depends/dilithium/ref/Makefile ]; then
            echo "Creating Dilithium Makefile..."
            echo 'CC ?= /usr/bin/cc' > depends/dilithium/ref/Makefile
            echo 'CFLAGS += -Wall -Wextra -Wpedantic -Wmissing-prototypes -Wredundant-decls -Wshadow -Wvla -Wpointer-arith -O3 -fomit-frame-pointer' >> depends/dilithium/ref/Makefile
            echo 'SOURCES = sign.c packing.c polyvec.c poly.c ntt.c reduce.c rounding.c fips202.c symmetric-shake.c randombytes.c' >> depends/dilithium/ref/Makefile
            echo '.PHONY: all clean' >> depends/dilithium/ref/Makefile
            echo 'all:' >> depends/dilithium/ref/Makefile
            printf '\t$(CC) $(CFLAGS) -DDILITHIUM_MODE=3 -c $(SOURCES)\n' >> depends/dilithium/ref/Makefile
            echo 'clean:' >> depends/dilithium/ref/Makefile
            printf '\trm -f *.o\n' >> depends/dilithium/ref/Makefile
          fi
          cd depends/dilithium/ref
          make clean || true
          make -j$(nproc)

      - name: Build all fuzzers
        run: |
          export FUZZ_CXX=clang++-14
          make -j$(nproc) fuzz

      - name: Verify all 20 fuzzers built
        run: |
          echo "Verifying fuzzer binaries exist..."
          # Original 11 fuzzers
          test -f fuzz_sha3
          test -f fuzz_transaction
          test -f fuzz_block
          test -f fuzz_compactsize
          test -f fuzz_network_message
          test -f fuzz_address
          test -f fuzz_difficulty
          test -f fuzz_subsidy
          test -f fuzz_merkle
          test -f fuzz_tx_validation
          test -f fuzz_utxo
          # New split fuzzers (Phase 3)
          test -f fuzz_address_encode
          test -f fuzz_address_validate
          test -f fuzz_address_bech32
          test -f fuzz_address_type
          test -f fuzz_network_create
          test -f fuzz_network_checksum
          test -f fuzz_network_command
          test -f fuzz_signature
          test -f fuzz_base58
          echo "✅ All 20 fuzzers built successfully"

      - name: Quick fuzzing smoke tests (30s each)
        run: |
          echo "Running smoke tests on all 20 fuzzers..."
          FUZZERS="fuzz_sha3 fuzz_transaction fuzz_block fuzz_compactsize fuzz_network_message fuzz_address fuzz_difficulty fuzz_subsidy fuzz_merkle fuzz_tx_validation fuzz_utxo fuzz_address_encode fuzz_address_validate fuzz_address_bech32 fuzz_address_type fuzz_network_create fuzz_network_checksum fuzz_network_command fuzz_signature fuzz_base58"

          for fuzzer in $FUZZERS; do
            if [ -x "$fuzzer" ]; then
              echo "Testing $fuzzer..."
              timeout 30 ./$fuzzer -max_total_time=30 || true
              echo "✅ $fuzzer smoke test complete"
            else
              echo "❌ $fuzzer not executable"
              exit 1
            fi
          done
          echo "✅ All 20 fuzzer smoke tests passed"

      - name: Upload fuzzer artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fuzzers-ubuntu-24.04
          path: fuzz_*
          retention-days: 30

      - name: Display fuzzer sizes
        run: |
          echo "Fuzzer binary sizes:"
          ls -lh fuzz_* | awk '{print $9, $5}'
