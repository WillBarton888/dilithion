# v1.0.12 Investigation Status Report

**Date:** November 18, 2025
**Status:** CRITICAL ISSUE - Bug #24 fix not working despite being in code

---

## Problem Summary

After rebuilding v1.0.12 with Bug #24 and Bug #25 fixes:
- ‚úÖ Bug #25 (Windows blockchain recovery) - WORKING
- ‚ùå Bug #24 (Mining performance) - NOT WORKING
  - Expected: ~2000 H/s (20 threads) or ~100 H/s per thread
  - Actual: 61 H/s total (~3 H/s per thread)
  - This is IDENTICAL to broken v1.0.10 performance

---

## Investigation Findings

### Code Verification ‚úÖ
1. **Source code HAS Bug #24 fix**
   - File: `src/miner/controller.cpp` lines 236-304
   - Pre-allocated 80-byte header buffer present
   - Template change detection logic present
   - Nonce-only update logic present

2. **Git history confirms Bug #24 commit**
   - Commit: 8dca67f (Nov 17, 2025)
   - Message: "fix: Mining performance - eliminate vector allocations in hot loop"
   - Current HEAD: a737667 (3 commits after Bug #24)

3. **Build process verified**
   - `mingw32-make clean` executed
   - controller.cpp WAS recompiled (confirmed in build log)
   - No compilation errors
   - Binary created successfully

### Binary Verification ‚úÖ
- All binaries same timestamp (Nov 18 06:34)
- All binaries same size (2.0 MB)
- Binary in ZIP matches build directory binary
- Binary copied to release-binaries/windows/ correctly

### Performance Testing ‚ùå
**Test 1: Windows v1.0.12 package**
```
[Mining] Hash rate: 61 H/s, Total hashes: 608
[Mining] Hash rate: 61 H/s, Total hashes: 1227
[Mining] Hash rate: 59 H/s, Total hashes: 1832
```
- 20 threads, ~3 H/s per thread
- Expected: ~100 H/s per thread

**Test 2: Version string check**
```
Dilithion Node v1.0.0
```
- Shows v1.0.0 instead of v1.0.12
- Indicates version string not updated (cosmetic issue)

---

## Possible Causes

### Theory 1: Template Change Detection Bug
The optimization relies on detecting when the block template changes:
```cpp
if (!headerInitialized || !(block.hashPrevBlock == cachedBlock.hashPrevBlock)) {
    // Re-serialize header (should happen rarely)
}
```

**Hypothesis:** Template might be changing on EVERY iteration, defeating optimization.

**Evidence needed:**
- Add debug logging to see how often template changes
- Check if `block.hashPrevBlock` is stable across iterations

### Theory 2: Compiler Optimization Issue
The optimization might be defeated by:
- Compiler optimizing out the code path
- Memory aliasing preventing optimization
- Incorrect memory ordering

**Evidence needed:**
- Check assembly output
- Try different compiler flags

### Theory 3: Runtime Code Path Issue
The optimized code path might not be executing due to:
- Conditional logic preventing it from running
- Thread safety issues
- RandomX interaction problems

**Evidence needed:**
- Add instrumentation to MiningWorker function
- Check if headerInitialized is ever set to true

### Theory 4: Bug in the Fix Itself
The fix might have a logic error that causes:
- Incorrect header serialization
- Nonce not being updated correctly
- Hash computation using wrong data

**Evidence needed:**
- Manual code review of Bug #24 fix
- Compare with known-good implementation

---

## Next Steps (Autonomous Work Plan)

### STEP 1: Add Debug Instrumentation ‚è≥
Add logging to `src/miner/controller.cpp` to track:
- How often template changes
- Whether headerInitialized is set
- Actual header serialization frequency

### STEP 2: Test with Debug Build
Rebuild with debug logging and test performance to identify:
- Is optimized path being taken?
- Why is performance still slow?

### STEP 3: Code Review
Manually review Bug #24 fix for logic errors:
- Check header buffer management
- Verify memcpy operations
- Confirm nonce offset calculation (should be 76)

### STEP 4: Compare with v1.0.11 Testnet Nodes
Check if Linux testnet nodes show same issue:
- They were rebuilt with Bug #24 fix
- If they also show 61 H/s, problem is in the fix itself
- If they show ~200 H/s (2 threads), problem is Windows-specific

### STEP 5: Binary Analysis
Use `strings` or disassembler to verify:
- Optimized code is actually in the binary
- No dead code elimination happened

---

## Critical Questions

1. **Why does source code have fix but binary doesn't show improvement?**
   - Code is there ‚úÖ
   - Code was compiled ‚úÖ
   - Binary contains code ‚úÖ
   - But performance unchanged ‚ùå

2. **Is this a Windows-specific issue?**
   - Need to check Linux testnet node performance
   - Compare Windows vs Linux compilation

3. **Is the fix fundamentally flawed?**
   - Original commit said it would improve 33x
   - But no improvement observed
   - Possible logic error in the fix?

---

## User Impact

**Current Status:**
- v1.0.12 package built and checksummed
- Bug #25 working (Windows blockchain recovery)
- Bug #24 NOT working (mining still slow)

**Recommendation:**
- DO NOT distribute v1.0.12 until Bug #24 verified working
- Performance must improve from 61 H/s to ~2000 H/s before release
- Need to identify and fix root cause

---

## Files Modified This Session

1. ‚úÖ `src/node/dilithion-node.cpp` - Bug #25 fix (2 `Close()` calls added)
2. ‚úÖ `releases/RELEASE-NOTES-v1.0.12.md` - Updated checksum
3. ‚úÖ `releases/dilithion-testnet-v1.0.12-windows-x64.zip` - Rebuilt package

**SHA-256:** f738d46f9050793abb0532028e1879422a06785140553de03b4cbd35a9c3dd21

---

## Commits Made

1. `92a2967` - fix: Close database before automatic blockchain wipe (Bug #25)
2. `a539644` - docs: Add comprehensive v1.0.12 release notes
3. `a737667` - chore: Update v1.0.12 SHA-256 checksum after rebuilding

---

**Status:** Continuing investigation autonomously...

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
